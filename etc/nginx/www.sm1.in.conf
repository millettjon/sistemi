# NAKED DOMAIN - HTTP
# Redirect to www and force use of https.
server {
  server_name sm1.in;
  rewrite ^ https://www.sm1.in$request_uri? permanent;
}

# NAKED DOMAIN - HTTPS
# Redirect to www.
server {
  server_name sm1.in;
  listen      443 ssl;
  ssl_certificate      /opt/www/etc/nginx/ssl/www.sm1.in/chain.crt;
  ssl_certificate_key  /opt/www/etc/nginx/ssl/www.sm1.in/server.unencrypted.key;
  rewrite ^ https://www.sm1.in$request_uri? permanent;
}

# WWW - HTTP
# Redirect to https site.
server {
  server_name www.sm1.in;
#  listen 80 default;
  rewrite ^ https://www.sm1.in$request_uri? permanent;
}

# WWW - HTTPS
# Proxy all requests to back end.
server {
  server_name www.sm1.in;
  #  listen      443 default ssl;
  listen      443 ssl;
  ssl_certificate      /opt/www/etc/nginx/ssl/www.sm1.in/chain.crt;
  ssl_certificate_key  /opt/www/etc/nginx/ssl/www.sm1.in/server.unencrypted.key;

  # Enable gzip compression.
  # TODO: enable gzip on more things (e.g., text/html)
  gzip on;
  gzip_types text/javascript text/css;

  location / {
    proxy_pass      http://127.0.0.1:2000;

    # Set standard headers needed for backend to know how the client
    # connected (e.g., to properly construct redirect urls).
    # Note: Jetty requires the Host header to include an explicit
    # server port in order to properly set the server-port request
    # parameter.
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Host $host:$server_port;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # TODO: setup optimizations (See: http://nginx.org/en/docs/http/configuring_https_servers.html)
  }
}
